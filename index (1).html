<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Seguimiento - Despacho de Aduana</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0a4d68;
            --primary-light: #088395;
            --accent: #05bfdb;
            --success: #00c48c;
            --warning: #ffa41b;
            --danger: #ff6b6b;
            --bg-dark: #0d1b2a;
            --bg-card: #1b263b;
            --bg-light: #415a77;
            --text: #e0e1dd;
            --text-muted: #778da9;
            --border: #2d3e50;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #162a40 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: rgba(27, 38, 59, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            padding: 25px 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 0.95rem;
            font-weight: 300;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(27, 38, 59, 0.5);
            border: 1px solid var(--border);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent);
            box-shadow: 0 8px 24px rgba(5, 191, 219, 0.2);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .toolbar {
            background: rgba(27, 38, 59, 0.5);
            border: 1px solid var(--border);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-light), var(--accent));
            color: white;
            box-shadow: 0 4px 12px rgba(5, 191, 219, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(5, 191, 219, 0.4);
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-card);
            border-color: var(--accent);
        }

        input, select {
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text);
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            flex: 1;
            min-width: 200px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(5, 191, 219, 0.1);
        }

        .operations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 20px;
        }

        .operation-card {
            background: rgba(27, 38, 59, 0.6);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .operation-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--accent);
        }

        .operation-card.completado::before { background: var(--success); }
        .operation-card.pendiente::before { background: var(--warning); }
        .operation-card.detenido::before { background: var(--danger); }

        .operation-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0,0,0,0.4);
            border-color: var(--accent);
        }

        .operation-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .operation-number {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent);
        }

        .operation-status {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-completado { background: rgba(0, 196, 140, 0.2); color: var(--success); }
        .status-pendiente { background: rgba(255, 164, 27, 0.2); color: var(--warning); }
        .status-en-curso { background: rgba(5, 191, 219, 0.2); color: var(--accent); }
        .status-detenido { background: rgba(255, 107, 107, 0.2); color: var(--danger); }

        .operation-detail {
            margin-bottom: 10px;
            display: flex;
            align-items: start;
            gap: 10px;
        }

        .detail-label {
            color: var(--text-muted);
            font-size: 0.8rem;
            min-width: 90px;
        }

        .detail-value {
            color: var(--text);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .operation-footer {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.8rem;
            flex: 1;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(13, 27, 42, 0.95);
            backdrop-filter: blur(8px);
            z-index: 1000;
            overflow-y: auto;
            padding: 40px 20px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            background: var(--bg-light);
            color: var(--text);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .operations-grid {
                grid-template-columns: 1fr;
            }

            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .btn, input, select {
                width: 100%;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .alert {
            background: rgba(255, 164, 27, 0.1);
            border: 1px solid var(--warning);
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--warning);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 20px;">
                <div>
                    <h1>üö¢ Seguimiento Estudio Carracedo</h1>
                    <p class="subtitle">Gesti√≥n integral de despachos de aduana</p>
                </div>
                <div style="background: rgba(5, 191, 219, 0.1); border: 1px solid var(--accent); border-radius: 12px; padding: 15px 20px; min-width: 250px;">
                    <label style="display: block; color: var(--text-muted); font-size: 0.85rem; margin-bottom: 8px; font-weight: 500;">üíµ Tipo de Cambio del D√≠a (USD ‚Üí ARS)</label>
                    <input type="number" id="exchangeRate" step="0.01" placeholder="Ej: 1050.50" 
                           style="width: 100%; padding: 10px 14px; font-size: 1.1rem; font-weight: 600; font-family: 'JetBrains Mono', monospace;"
                           onchange="saveExchangeRate()">
                    <div id="exchangeRateDisplay" style="margin-top: 8px; color: var(--accent); font-size: 0.85rem; font-family: 'JetBrains Mono', monospace;"></div>
                </div>
            </div>
        </header>

        <div class="stats-grid" id="statsGrid"></div>

        <div class="toolbar">
            <button class="btn btn-primary" onclick="openNewOperationModal()">
                + Nueva Operaci√≥n
            </button>
            <input type="text" id="searchInput" placeholder="üîç Buscar por carpeta, cliente, proveedor...">
            <select id="filterStatus">
                <option value="">Todos los estados</option>
                <option value="Pendiente">Pendiente</option>
                <option value="En curso">En curso</option>
                <option value="Detenido">Detenido</option>
                <option value="Completado">Completado</option>
            </select>
            <select id="filterClient">
                <option value="">Todos los clientes</option>
            </select>
            <button class="btn btn-secondary" onclick="recalculateAllVepPesos()" title="Recalcular VEP en pesos de todas las operaciones">
                üîÑ Recalcular VEP
            </button>
            <button class="btn btn-secondary" onclick="generatePDFReport()" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border: none;" title="Generar informe PDF con estad√≠sticas y gr√°ficos">
                üìÑ Generar Informe PDF
            </button>
        </div>

        <div class="operations-grid" id="operationsGrid"></div>

        <!-- Toolbar inferior con opciones de exportaci√≥n/importaci√≥n -->
        <div class="toolbar" style="margin-top: 30px; justify-content: center;">
            <button class="btn btn-secondary" onclick="copyShareLink()" title="Copiar link para compartir entre dispositivos">
                üîó Copiar Link
            </button>
            <button class="btn btn-secondary" onclick="exportToExcel()">
                üìä Exportar Excel
            </button>
            <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                üì• Importar Excel
            </button>
            <input type="file" id="importFile" accept=".xlsx" style="display: none;" onchange="importFromExcel(event)">
        </div>

        <!-- Footer con cr√©ditos -->
        <div style="text-align: center; padding: 20px; margin-top: 20px; color: var(--text-muted); font-size: 0.85rem;">
            Creado por Manuel Carracedo para Estudio Carracedo ¬© 2025
        </div>
    </div>

    <div class="modal" id="operationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Nueva Operaci√≥n</h2>
                <button class="close-modal" onclick="closeModal()">√ó</button>
            </div>
            <form id="operationForm" onsubmit="saveOperation(event)">
                <div class="form-group">
                    <label>N√∫mero de Carpeta *</label>
                    <input type="text" id="numeroCarpeta" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tipo de Operaci√≥n *</label>
                        <select id="tipoOperacion" required>
                            <option value="">Seleccionar...</option>
                            <option value="Importaci√≥n">Importaci√≥n</option>
                            <option value="Exportaci√≥n">Exportaci√≥n</option>
                            <option value="Zona Franca">Zona Franca</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cliente *</label>
                        <input type="text" id="cliente" list="clientesList" required>
                        <datalist id="clientesList"></datalist>
                    </div>
                </div>
                <div class="form-group">
                    <label>Proveedor</label>
                    <input type="text" id="proveedor">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha Ingreso *</label>
                        <input type="date" id="fechaIngreso" required>
                    </div>
                    <div class="form-group">
                        <label>Estado ANMAT</label>
                        <select id="estadoAnmat">
                            <option value="">Seleccionar...</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="En revisi√≥n">En revisi√≥n</option>
                            <option value="PosAnmat">PosAnmat</option>
                            <option value="Aprobado">Aprobado</option>
                            <option value="Rechazado">Rechazado</option>
                        </select>
                    </div>
                </div>
                <!-- NUEVO: N√∫mero ANMAT -->
                <div class="form-group">
                    <label>N√∫mero ANMAT</label>
                    <input type="text" id="numeroAnmat" placeholder="Ej: 123456/24">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Gu√≠a Original</label>
                        <select id="guiaOriginal">
                            <option value="">Seleccionar...</option>
                            <option value="S√≠">S√≠</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Valor en Ana (USD)</label>
                        <input type="number" id="valorAna" step="0.01">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>VEP (USD)</label>
                        <input type="number" id="vepUsd" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>VEP (Pesos)</label>
                        <input type="number" id="vepPesos" step="0.01">
                    </div>
                </div>
                <div class="form-group">
                    <label>Estado Operaci√≥n *</label>
                    <select id="estadoOperacion" required>
                        <option value="Pendiente">Pendiente</option>
                        <option value="En curso">En curso</option>
                        <option value="Detenido">Detenido</option>
                        <option value="Completado">Completado</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>N√∫mero de Despacho</label>
                        <input type="text" id="numeroDespacho">
                    </div>
                    <div class="form-group">
                        <label>Fecha Oficializaci√≥n</label>
                        <input type="date" id="fechaOf">
                    </div>
                </div>
                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Guardar</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCOWbNoM5fdUuIjAyFNtu_yjWiVmAMEdho",
            authDomain: "seguimiento-carracedo-3e837.firebaseapp.com",
            databaseURL: "https://seguimiento-carracedo-3e837-default-rtdb.firebaseio.com",
            projectId: "seguimiento-carracedo-3e837",
            storageBucket: "seguimiento-carracedo-3e837.firebasestorage.app",
            messagingSenderId: "2196327624",
            appId: "1:2196327624:web:796c6dd3e80ad89eb4e9fd"
        };

        // Inicializar Firebase
        let database;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log('‚úÖ Firebase conectado');
        } catch (error) {
            console.error('Error al conectar Firebase:', error);
        }

        let operations = [];
        let editingId = null;
        let exchangeRate = 0;
        let workspaceId = null;

        // Cargar datos al iniciar
        window.addEventListener('DOMContentLoaded', async () => {
            initWorkspace();
            await loadFromFirebase();
            await loadExchangeRate();
            renderStats();
            renderOperations();
            updateClientFilter();
            setupFilters();
            document.getElementById('fechaIngreso').valueAsDate = new Date();
            setupVepCalculation();
            
            // Escuchar cambios en tiempo real
            listenToFirebaseChanges();
        });

        function initWorkspace() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                workspaceId = hash;
            } else {
                workspaceId = 'ws_' + Date.now() + '_' + Math.random().toString(36).substring(7);
                window.location.hash = workspaceId;
            }
            console.log('Workspace ID:', workspaceId);
        }

        // Cargar datos desde Firebase
        async function loadFromFirebase() {
            if (!database) {
                console.warn('Firebase no disponible');
                loadFromStorage();
                return;
            }
            
            try {
                const ref = database.ref('workspaces/' + workspaceId + '/operations');
                const snapshot = await ref.once('value');
                if (snapshot.exists()) {
                    operations = snapshot.val() || [];
                    console.log('‚úÖ Datos cargados desde Firebase:', operations.length, 'operaciones');
                } else {
                    console.log('‚ÑπÔ∏è No hay datos en Firebase, intentando localStorage');
                    loadFromStorage();
                }
            } catch (error) {
                console.error('Error al cargar desde Firebase:', error);
                loadFromStorage();
            }
        }

        // Guardar datos en Firebase
        async function saveToFirebase() {
            saveToStorage(); // Backup local
            
            if (!database) return;
            
            try {
                const ref = database.ref('workspaces/' + workspaceId + '/operations');
                await ref.set(operations);
                console.log('‚úÖ Datos guardados en Firebase');
            } catch (error) {
                console.error('Error al guardar en Firebase:', error);
            }
        }

        // Escuchar cambios en tiempo real
        function listenToFirebaseChanges() {
            if (!database) return;
            
            const ref = database.ref('workspaces/' + workspaceId + '/operations');
            ref.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const newOps = snapshot.val() || [];
                    // Solo actualizar si los datos cambiaron
                    if (JSON.stringify(newOps) !== JSON.stringify(operations)) {
                        operations = newOps;
                        renderStats();
                        renderOperations();
                        updateClientFilter();
                        console.log('üîÑ Datos actualizados en tiempo real');
                    }
                }
            });
        }

        // Guardar tipo de cambio en Firebase
        async function saveExchangeRate() {
            exchangeRate = parseFloat(document.getElementById('exchangeRate').value) || 0;
            localStorage.setItem('exchangeRate_' + workspaceId, exchangeRate);
            
            if (database && exchangeRate > 0) {
                try {
                    const ref = database.ref('workspaces/' + workspaceId + '/exchangeRate');
                    await ref.set(exchangeRate);
                } catch (error) {
                    console.error('Error al guardar tipo de cambio:', error);
                }
            }
            
            updateExchangeRateDisplay();
        }

        // Cargar tipo de cambio desde Firebase
        async function loadExchangeRate() {
            const stored = localStorage.getItem('exchangeRate_' + workspaceId);
            
            if (database) {
                try {
                    const ref = database.ref('workspaces/' + workspaceId + '/exchangeRate');
                    const snapshot = await ref.once('value');
                    if (snapshot.exists()) {
                        exchangeRate = snapshot.val();
                    } else if (stored) {
                        exchangeRate = parseFloat(stored);
                    }
                } catch (error) {
                    console.error('Error al cargar tipo de cambio:', error);
                    if (stored) exchangeRate = parseFloat(stored);
                }
            } else if (stored) {
                exchangeRate = parseFloat(stored);
            }
            
            if (exchangeRate > 0) {
                document.getElementById('exchangeRate').value = exchangeRate;
                updateExchangeRateDisplay();
            }
        }

        function updateExchangeRateDisplay() {
            const display = document.getElementById('exchangeRateDisplay');
            if (exchangeRate > 0) {
                display.textContent = `1 USD = ${exchangeRate.toLocaleString('es-AR')} ARS`;
            } else {
                display.textContent = '';
            }
        }

        function setupVepCalculation() {
            const vepUsdInput = document.getElementById('vepUsd');
            const vepPesosInput = document.getElementById('vepPesos');
            
            vepUsdInput.addEventListener('input', () => {
                if (exchangeRate > 0) {
                    const vepUsd = parseFloat(vepUsdInput.value) || 0;
                    vepPesosInput.value = (vepUsd * exchangeRate).toFixed(2);
                }
            });
        }

        function loadFromStorage() {
            const stored = localStorage.getItem('aduanaOperations_' + workspaceId);
            if (stored) {
                operations = JSON.parse(stored);
            }
        }

        function saveToStorage() {
            localStorage.setItem('aduanaOperations_' + workspaceId, JSON.stringify(operations));
        }

        function renderStats(filteredOps = null) {
            const opsToCount = filteredOps || operations;
            
            const stats = {
                total: opsToCount.length,
                pendiente: opsToCount.filter(o => o.estadoOperacion === 'Pendiente').length,
                enCurso: opsToCount.filter(o => o.estadoOperacion === 'En curso').length,
                completado: opsToCount.filter(o => o.estadoOperacion === 'Completado').length,
                detenido: opsToCount.filter(o => o.estadoOperacion === 'Detenido').length
            };

            const filterClient = document.getElementById('filterClient')?.value;
            const clientLabel = filterClient ? ` - ${filterClient}` : '';

            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--accent);">${stats.total}</div>
                    <div class="stat-label">Total Operaciones${clientLabel}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--warning);">${stats.pendiente}</div>
                    <div class="stat-label">Pendientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--primary-light);">${stats.enCurso}</div>
                    <div class="stat-label">En Curso</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--success);">${stats.completado}</div>
                    <div class="stat-label">Completados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--danger);">${stats.detenido}</div>
                    <div class="stat-label">Detenidos</div>
                </div>
            `;
            document.getElementById('statsGrid').innerHTML = statsHtml;
        }

        function renderOperations() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filterStatus = document.getElementById('filterStatus').value;
            const filterClient = document.getElementById('filterClient').value;

            let filtered = operations.filter(op => {
                const matchSearch = !searchTerm || 
                    op.numeroCarpeta.toLowerCase().includes(searchTerm) ||
                    op.cliente.toLowerCase().includes(searchTerm) ||
                    (op.proveedor && op.proveedor.toLowerCase().includes(searchTerm));
                const matchStatus = !filterStatus || op.estadoOperacion === filterStatus;
                const matchClient = !filterClient || op.cliente === filterClient;
                return matchSearch && matchStatus && matchClient;
            });

            renderStats(filtered);

            filtered.sort((a, b) => {
                const aCompleted = a.estadoOperacion === 'Completado' ? 1 : 0;
                const bCompleted = b.estadoOperacion === 'Completado' ? 1 : 0;
                
                if (aCompleted !== bCompleted) {
                    return aCompleted - bCompleted;
                }
                
                return b.numeroCarpeta.localeCompare(a.numeroCarpeta, undefined, { numeric: true, sensitivity: 'base' });
            });

            if (filtered.length === 0) {
                document.getElementById('operationsGrid').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <h3>No hay operaciones</h3>
                        <p>Agrega tu primera operaci√≥n para comenzar</p>
                    </div>
                `;
                return;
            }

            const html = filtered.map(op => {
                const daysSince = Math.floor((new Date() - new Date(op.fechaIngreso)) / (1000 * 60 * 60 * 24));
                const isDelayed = op.estadoOperacion === 'Pendiente' && daysSince > 15;
                const statusClass = op.estadoOperacion.toLowerCase().replace(' ', '-');

                return `
                    <div class="operation-card ${statusClass}">
                        <div class="operation-header">
                            <div class="operation-number">${op.numeroCarpeta}</div>
                            <div class="operation-status status-${statusClass}">${op.estadoOperacion}</div>
                        </div>
                        <div class="operation-detail">
                            <span class="detail-label">Cliente:</span>
                            <span class="detail-value">${op.cliente}</span>
                        </div>
                        <div class="operation-detail">
                            <span class="detail-label">Tipo:</span>
                            <span class="detail-value">${op.tipoOperacion}</span>
                        </div>
                        ${op.proveedor ? `
                        <div class="operation-detail">
                            <span class="detail-label">Proveedor:</span>
                            <span class="detail-value">${op.proveedor}</span>
                        </div>` : ''}
                        <div class="operation-detail">
                            <span class="detail-label">Ingreso:</span>
                            <span class="detail-value">${formatDate(op.fechaIngreso)} (hace ${daysSince} d√≠as)</span>
                        </div>
                        ${op.estadoAnmat ? `
                        <div class="operation-detail">
                            <span class="detail-label">ANMAT:</span>
                            <span class="detail-value">${op.estadoAnmat}</span>
                        </div>` : ''}
                        ${op.numeroAnmat ? `
                        <div class="operation-detail">
                            <span class="detail-label">N¬∞ ANMAT:</span>
                            <span class="detail-value" style="font-family: 'JetBrains Mono', monospace; color: var(--accent);">${op.numeroAnmat}</span>
                        </div>` : ''}
                        <div class="operation-detail">
                            <span class="detail-label">VEP USD:</span>
                            <span class="detail-value" style="color: var(--success); font-weight: 600;">US$ ${(parseFloat(op.vepUsd) || 0).toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                        </div>
                        <div class="operation-detail">
                            <span class="detail-label">VEP ARS:</span>
                            <span class="detail-value" style="color: var(--accent); font-weight: 600;">$ ${(parseFloat(op.vepPesos) || 0).toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                        </div>
                        ${op.numeroDespacho ? `
                        <div class="operation-detail">
                            <span class="detail-label">N¬∞ Despacho:</span>
                            <span class="detail-value">${op.numeroDespacho}</span>
                        </div>` : ''}
                        ${isDelayed ? '<div class="alert">‚ö†Ô∏è Operaci√≥n demorada: m√°s de 15 d√≠as</div>' : ''}
                        <div class="operation-footer">
                            <button class="btn btn-secondary btn-small" onclick="editOperation('${op.id}')">Editar</button>
                            <button class="btn btn-secondary btn-small" onclick="deleteOperation('${op.id}')">Eliminar</button>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('operationsGrid').innerHTML = html;
        }

        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function openNewOperationModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'Nueva Operaci√≥n';
            document.getElementById('operationForm').reset();
            document.getElementById('fechaIngreso').valueAsDate = new Date();
            document.getElementById('operationModal').classList.add('active');
            setupVepCalculation();
        }

        function editOperation(id) {
            editingId = id;
            const op = operations.find(o => o.id === id);
            if (!op) return;

            document.getElementById('modalTitle').textContent = 'Editar Operaci√≥n';
            document.getElementById('numeroCarpeta').value = op.numeroCarpeta;
            document.getElementById('tipoOperacion').value = op.tipoOperacion;
            document.getElementById('cliente').value = op.cliente;
            document.getElementById('proveedor').value = op.proveedor || '';
            document.getElementById('fechaIngreso').value = op.fechaIngreso;
            document.getElementById('estadoAnmat').value = op.estadoAnmat || '';
            document.getElementById('numeroAnmat').value = op.numeroAnmat || '';
            document.getElementById('guiaOriginal').value = op.guiaOriginal || '';
            document.getElementById('valorAna').value = op.valorAna || '';
            document.getElementById('vepUsd').value = op.vepUsd || '';
            document.getElementById('vepPesos').value = op.vepPesos || '';
            document.getElementById('estadoOperacion').value = op.estadoOperacion;
            document.getElementById('numeroDespacho').value = op.numeroDespacho || '';
            document.getElementById('fechaOf').value = op.fechaOf || '';

            document.getElementById('operationModal').classList.add('active');
            setupVepCalculation();
        }

        function closeModal() {
            document.getElementById('operationModal').classList.remove('active');
        }

        function saveOperation(event) {
            event.preventDefault();

            const formData = {
                id: editingId || Date.now().toString(),
                numeroCarpeta: document.getElementById('numeroCarpeta').value,
                tipoOperacion: document.getElementById('tipoOperacion').value,
                cliente: document.getElementById('cliente').value,
                proveedor: document.getElementById('proveedor').value,
                fechaIngreso: document.getElementById('fechaIngreso').value,
                estadoAnmat: document.getElementById('estadoAnmat').value,
                numeroAnmat: document.getElementById('numeroAnmat').value,
                guiaOriginal: document.getElementById('guiaOriginal').value,
                valorAna: document.getElementById('valorAna').value,
                vepUsd: document.getElementById('vepUsd').value,
                vepPesos: document.getElementById('vepPesos').value,
                estadoOperacion: document.getElementById('estadoOperacion').value,
                numeroDespacho: document.getElementById('numeroDespacho').value,
                fechaOf: document.getElementById('fechaOf').value
            };

            if (editingId) {
                const index = operations.findIndex(o => o.id === editingId);
                operations[index] = formData;
            } else {
                operations.push(formData);
            }

            saveToFirebase();
            closeModal();
            renderStats();
            renderOperations();
            updateClientFilter();
        }

        function deleteOperation(id) {
            if (confirm('¬øEst√°s seguro de eliminar esta operaci√≥n?')) {
                operations = operations.filter(o => o.id !== id);
                saveToFirebase();
                renderStats();
                renderOperations();
                updateClientFilter();
            }
        }

        function recalculateAllVepPesos() {
            if (!exchangeRate || exchangeRate <= 0) {
                alert('Por favor, ingres√° primero el Tipo de Cambio del d√≠a en la casilla de arriba.');
                document.getElementById('exchangeRate').focus();
                return;
            }

            let updated = 0;
            operations.forEach(op => {
                const vepUsd = parseFloat(op.vepUsd) || 0;
                if (vepUsd > 0) {
                    op.vepPesos = (vepUsd * exchangeRate).toFixed(2);
                    updated++;
                }
            });

            if (updated > 0) {
                saveToFirebase();
                renderOperations();
                alert(`‚úÖ Se recalcul√≥ el VEP en pesos de ${updated} operaci√≥n(es) usando el tipo de cambio: $${exchangeRate.toLocaleString('es-AR')}`);
            } else {
                alert('No hay operaciones con VEP en USD para recalcular.');
            }
        }

        function copyShareLink() {
            const shareUrl = window.location.href;
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert('‚úÖ Link copiado al portapapeles!\n\nUs√° este link en todos tus dispositivos para acceder a los mismos datos:\n\n' + shareUrl + '\n\nüí° Guardalo en favoritos o notas para no perderlo.');
            }).catch(() => {
                prompt('Copi√° este link para compartir entre dispositivos:', shareUrl);
            });
        }

        function updateClientFilter() {
            const clients = [...new Set(operations.map(o => o.cliente))].sort();
            const datalist = document.getElementById('clientesList');
            const select = document.getElementById('filterClient');
            
            datalist.innerHTML = clients.map(c => `<option value="${c}">`).join('');
            select.innerHTML = '<option value="">Todos los clientes</option>' + 
                clients.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function setupFilters() {
            document.getElementById('searchInput').addEventListener('input', renderOperations);
            document.getElementById('filterStatus').addEventListener('change', renderOperations);
            document.getElementById('filterClient').addEventListener('change', renderOperations);
        }

        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            const data = operations.map(op => ({
                'N√∫mero de Carpeta': op.numeroCarpeta,
                'Tipo de Operaci√≥n': op.tipoOperacion,
                'Cliente': op.cliente,
                'Proveedor': op.proveedor,
                'Fecha Ingreso': op.fechaIngreso,
                'Estado ANMAT': op.estadoAnmat,
                'N√∫mero ANMAT': op.numeroAnmat,
                'Gu√≠a Original': op.guiaOriginal,
                'Valor en Ana u$': op.valorAna,
                'Vep u$': op.vepUsd,
                'Vep Pesos': op.vepPesos,
                'Estado Operaci√≥n': op.estadoOperacion,
                'N Despa': op.numeroDespacho,
                'Fecha Of': op.fechaOf
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Seguimiento Operaciones');

            XLSX.writeFile(wb, `Seguimiento_Aduana_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                const imported = jsonData.map((row, index) => ({
                    id: Date.now().toString() + index,
                    numeroCarpeta: row['N√∫mero de Carpeta'] || '',
                    tipoOperacion: row['Tipo de Operaci√≥n'] || 'Importaci√≥n',
                    cliente: row['Cliente'] || '',
                    proveedor: row['Proveedor'] || '',
                    fechaIngreso: row['Fecha Ingreso'] ? excelDateToJS(row['Fecha Ingreso']) : new Date().toISOString().split('T')[0],
                    estadoAnmat: row['Estado ANMAT'] || '',
                    numeroAnmat: row['N√∫mero ANMAT'] || '',
                    guiaOriginal: row['Gu√≠a Original'] || '',
                    valorAna: row['Valor en Ana u$'] || '',
                    vepUsd: row['Vep u$'] || '',
                    vepPesos: row['Vep Pesos'] || '',
                    estadoOperacion: row['Estado Operaci√≥n'] || 'Pendiente',
                    numeroDespacho: row['N Despa'] || '',
                    fechaOf: row['Fecha Of'] ? excelDateToJS(row['Fecha Of']) : ''
                }));

                operations = imported;
                saveToFirebase();
                renderStats();
                renderOperations();
                updateClientFilter();
                alert(`${imported.length} operaciones importadas correctamente`);
            };
            reader.readAsArrayBuffer(file);
        }

        function excelDateToJS(excelDate) {
            if (typeof excelDate === 'string') return excelDate;
            const date = new Date((excelDate - 25569) * 86400 * 1000);
            return date.toISOString().split('T')[0];
        }

        async function generatePDFReport() {
            if (operations.length === 0) {
                alert('No hay operaciones para generar el informe');
                return;
            }

            const loadingMsg = document.createElement('div');
            loadingMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); color: white; padding: 30px 50px; border-radius: 15px; z-index: 10000; font-size: 1.2rem;';
            loadingMsg.textContent = 'üìÑ Generando informe PDF...';
            document.body.appendChild(loadingMsg);

            try {
                const clientStats = {};
                operations.forEach(op => {
                    if (!clientStats[op.cliente]) {
                        clientStats[op.cliente] = {
                            total: 0,
                            pendiente: 0,
                            enCurso: 0,
                            detenido: 0,
                            completado: 0,
                            totalValorAna: 0,
                            totalVepUsd: 0,
                            totalVepPesos: 0
                        };
                    }
                    
                    const stats = clientStats[op.cliente];
                    stats.total++;
                    
                    switch(op.estadoOperacion.toLowerCase()) {
                        case 'pendiente': stats.pendiente++; break;
                        case 'en curso': stats.enCurso++; break;
                        case 'detenido': stats.detenido++; break;
                        case 'completado': stats.completado++; break;
                    }
                    
                    stats.totalValorAna += parseFloat(op.valorAna) || 0;
                    stats.totalVepUsd += parseFloat(op.vepUsd) || 0;
                    stats.totalVepPesos += parseFloat(op.vepPesos) || 0;
                });

                const canvas = document.createElement('canvas');
                canvas.width = 800;
                canvas.height = 400;
                document.body.appendChild(canvas);

                const ctx = canvas.getContext('2d');
                
                const clientes = Object.keys(clientStats);
                const totales = clientes.map(c => clientStats[c].total);

                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: clientes,
                        datasets: [{
                            label: 'Total Operaciones',
                            data: totales,
                            backgroundColor: 'rgba(5, 191, 219, 0.7)',
                            borderColor: 'rgba(5, 191, 219, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Operaciones por Cliente',
                                font: { size: 18, weight: 'bold' },
                                color: '#0a4d68'
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });

                await new Promise(resolve => setTimeout(resolve, 500));

                const chartImage = canvas.toDataURL('image/png');
                
                document.body.removeChild(canvas);
                chart.destroy();

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let yPos = 20;

                doc.setFontSize(22);
                doc.setTextColor(10, 77, 104);
                doc.text('Informe de Seguimiento - Estudio Carracedo', pageWidth / 2, yPos, { align: 'center' });
                
                yPos += 10;
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                const fechaHoy = new Date().toLocaleDateString('es-AR', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                doc.text('Fecha: ' + fechaHoy, pageWidth / 2, yPos, { align: 'center' });
                
                yPos += 15;

                doc.setFontSize(16);
                doc.setTextColor(10, 77, 104);
                doc.text('Resumen General', 15, yPos);
                
                yPos += 10;
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                
                const totalOps = operations.length;
                const pendientes = operations.filter(o => o.estadoOperacion === 'Pendiente').length;
                const enCurso = operations.filter(o => o.estadoOperacion === 'En curso').length;
                const detenidos = operations.filter(o => o.estadoOperacion === 'Detenido').length;
                const completados = operations.filter(o => o.estadoOperacion === 'Completado').length;

                doc.text('Total de Operaciones: ' + totalOps, 20, yPos);
                yPos += 7;
                doc.text('Pendientes: ' + pendientes, 20, yPos);
                yPos += 7;
                doc.text('En Curso: ' + enCurso, 20, yPos);
                yPos += 7;
                doc.text('Detenidos: ' + detenidos, 20, yPos);
                yPos += 7;
                doc.text('Completados: ' + completados, 20, yPos);
                
                yPos += 15;

                doc.addImage(chartImage, 'PNG', 15, yPos, 180, 90);
                yPos += 100;

                doc.addPage();
                yPos = 20;

                doc.setFontSize(16);
                doc.setTextColor(10, 77, 104);
                doc.text('Detalle por Cliente', 15, yPos);
                yPos += 10;

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);

                Object.keys(clientStats).sort().forEach(cliente => {
                    const stats = clientStats[cliente];
                    
                    if (yPos > pageHeight - 50) {
                        doc.addPage();
                        yPos = 20;
                    }

                    doc.setFontSize(12);
                    doc.setTextColor(8, 131, 149);
                    doc.text(cliente, 15, yPos);
                    yPos += 7;

                    doc.setFontSize(10);
                    doc.setTextColor(60, 60, 60);
                    doc.text('  Total operaciones: ' + stats.total, 20, yPos);
                    yPos += 6;
                    
                    const estadosText = '  Pendientes: ' + stats.pendiente + ' | En curso: ' + stats.enCurso + 
                                      ' | Detenidos: ' + stats.detenido + ' | Completados: ' + stats.completado;
                    doc.text(estadosText, 20, yPos);
                    yPos += 6;
                    
                    if (stats.totalValorAna > 0) {
                        const valorAnaFormatted = stats.totalValorAna.toLocaleString('es-AR', {
                            minimumFractionDigits: 2, 
                            maximumFractionDigits: 2
                        });
                        doc.text('  Valor en ANA (USD): $' + valorAnaFormatted, 20, yPos);
                        yPos += 6;
                    }
                    
                    if (stats.totalVepUsd > 0) {
                        const vepUsdFormatted = stats.totalVepUsd.toLocaleString('es-AR', {
                            minimumFractionDigits: 2, 
                            maximumFractionDigits: 2
                        });
                        doc.text('  VEP Total (USD): $' + vepUsdFormatted, 20, yPos);
                        yPos += 6;
                    }
                    
                    if (stats.totalVepPesos > 0) {
                        const vepPesosFormatted = stats.totalVepPesos.toLocaleString('es-AR', {
                            minimumFractionDigits: 2, 
                            maximumFractionDigits: 2
                        });
                        doc.text('  VEP Total (ARS): $' + vepPesosFormatted, 20, yPos);
                        yPos += 6;
                    }
                    
                    yPos += 5;
                });

                const nombreArchivo = 'Informe_Seguimiento_' + new Date().toISOString().split('T')[0] + '.pdf';
                doc.save(nombreArchivo);
                
                document.body.removeChild(loadingMsg);
                alert('Informe PDF generado exitosamente');

            } catch (error) {
                console.error('Error generando PDF:', error);
                if (document.body.contains(loadingMsg)) {
                    document.body.removeChild(loadingMsg);
                }
                alert('Error al generar el PDF. Por favor, intenta de nuevo.');
            }
        }
    </script>
</body>
</html>
